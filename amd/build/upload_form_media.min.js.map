{"version":3,"sources":["../src/upload_form_media.js"],"names":["ALLOWED_TYPES","CSS","HIDDEN","HOVER","ERROR","SELECTORS","NAME","TAGS","DESC","FILE_PICKER","STUDENT_CONTENT","TERM","FILE_DROP_AREA","FILE_INFO","FILE_ERROR","UPLOAD_PART_2","root","selectedFile","init","rootSelector","registerEventListeners","find","on","e","preventDefault","stopPropagation","currentTarget","addClass","removeClass","file","originalEvent","dataTransfer","files","handleFile","checkFile","upload","updateFileInfo","showFileError","prop","val","name","error","getFileError","key","component","indexOf","type","string","text","toggleClass","formData","getFormData","Promise","all","KalturaAjax","getUploadCredentials","ModalFactory","create","ModalKalturaProgress","getType","uploadCredentials","progressModal","show","KalturaUploader","progressCallback","xml","newEntryId","KalturaEvents","uploadComplete","Notification","exception","hide","destroy","trim","tags","desc","studentContent","term","assessment"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport $ from 'jquery';\nimport {get_string as getString} from 'core/str';\nimport {publish} from 'core/pubsub';\nimport Notification from 'core/notification';\n\nimport KalturaAjax from 'local_kaltura/kaltura_ajax';\nimport KalturaUploader from 'local_kaltura/kaltura_uploader';\nimport KalturaEvents from 'local_kaltura/kaltura_events';\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalKalturaProgress from 'local_kaltura/modal_kaltura_progress';\n\nconst ALLOWED_TYPES = [\n    'video/3gpp',\n    'video/avi',\n    'video/dvd',\n    'video/mp4',\n    'video/mpeg',\n    'video/mts',\n    'video/ogg',\n    'video/quicktime',\n    'video/vnd.rn-realvideo',\n    'video/VP8',\n    'video/webm',\n    'video/x-msvideo',\n    'video/x-flv',\n    'video/x-f4v',\n    'video/x-ms-asf',\n    'video/x-ms-wmv',\n    'video/x-matroska'\n];\n\nconst CSS = {\n    HIDDEN: 'hidden',\n    HOVER: 'highlighted',\n    ERROR: 'file-error'\n};\n\nconst SELECTORS = {\n    NAME: '#entry_name',\n    TAGS: '#entry_tags',\n    DESC: '#entry_desc',\n    FILE_PICKER: '#entry_file',\n    STUDENT_CONTENT: '[name=\"student\"]',\n    TERM: '#entry_term',\n    FILE_DROP_AREA: '[data-region=\"file-drop-area\"]',\n    FILE_INFO: '[data-region=\"file-info\"]',\n    FILE_ERROR: '[data-region=\"file-error\"]',\n    UPLOAD_PART_2: '[data-region=\"upload-part-2\"]'\n};\n\nlet root;\nlet selectedFile;\n\nexport const init = (rootSelector) => {\n    root = $(rootSelector);\n    registerEventListeners();\n};\n\nconst registerEventListeners = () => {\n    root.find(SELECTORS.FILE_DROP_AREA).on('dragenter dragover dragleave drop', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n    });\n\n    root.find(SELECTORS.FILE_DROP_AREA).on('dragenter dragover', (e) => {\n        $(e.currentTarget).addClass(CSS.HOVER);\n    });\n\n    root.find(SELECTORS.FILE_DROP_AREA).on('dragleave drop', (e) => {\n        $(e.currentTarget).removeClass(CSS.HOVER);\n    });\n\n    root.find(SELECTORS.FILE_DROP_AREA).on('drop', (e) => {\n        const file = e.originalEvent.dataTransfer.files[0];\n        handleFile(file);\n    });\n\n    root.find(SELECTORS.FILE_PICKER).on('change', (e) => {\n        const file = e.currentTarget.files[0];\n        handleFile(file);\n    });\n\n    root.on('submit', (e) => {\n        e.preventDefault();\n        if (checkFile(selectedFile)) {\n            upload();\n        }\n    });\n\n    root.on('reset', () => {\n        selectedFile = null;\n        updateFileInfo(null);\n        showFileError(null);\n        root.find(SELECTORS.UPLOAD_PART_2).addClass(CSS.HIDDEN);\n        root.find(SELECTORS.TERM).prop('disabled', false);\n    });\n\n    root.on('change', SELECTORS.STUDENT_CONTENT, (e) => {\n        root.find(SELECTORS.TERM).prop('disabled', $(e.currentTarget).val() === 'Yes');\n    });\n\n};\n\nconst handleFile = (file) => {\n    updateFileInfo(file);\n    if (checkFile(file)) {\n        selectedFile = file;\n        root.find(SELECTORS.NAME).val(file.name);\n        root.find(SELECTORS.UPLOAD_PART_2).removeClass(CSS.HIDDEN);\n    }\n};\n\nconst checkFile = (file) => {\n    const error = getFileError(file);\n    showFileError(error);\n    if (error) return false;\n    else return true;\n};\n\nconst getFileError = (file) => {\n    if (!file) {\n        return {key: 'video_required', component: 'local_kaltura'};\n    } else if (ALLOWED_TYPES.indexOf(file.type) === -1) {\n        return {key: 'video_valid_type', component: 'local_kaltura'};\n    } else {\n        return null;\n    }\n};\n\nconst showFileError = async (error) => {\n    const string = error ? await getString(error.key, error.component) : '';\n    root.find(SELECTORS.FILE_ERROR).text(string);\n    root.find(SELECTORS.FILE_DROP_AREA).toggleClass(CSS.ERROR, error ? true : false);\n};\n\nconst updateFileInfo = async (file) => {\n    const string = file ? getString('file_selected', 'local_kaltura', file.name) : getString('no_file_selected', 'local_kaltura');\n    root.find(SELECTORS.FILE_INFO).text(await string);\n};\n\nconst upload = async () => {\n    let uploadCredentials, progressModal;\n    try {\n        const formData = getFormData();\n        [uploadCredentials, progressModal] = await Promise.all([\n            KalturaAjax.getUploadCredentials(),\n            ModalFactory.create({type: ModalKalturaProgress.getType()})\n        ]);\n        progressModal.show();\n        const xml = await KalturaUploader.upload(formData, uploadCredentials, progressModal.progressCallback);\n        const newEntryId = $(xml).find('entryId').text();\n        publish(KalturaEvents.uploadComplete, newEntryId);\n    } catch (error) {\n        Notification.exception(error);\n    } finally {\n        progressModal.hide();\n        progressModal.destroy();\n    }\n};\n\nconst getFormData = () => {\n    return {\n        file: selectedFile,\n        name: root.find(SELECTORS.NAME).val().trim(),\n        tags: root.find(SELECTORS.TAGS).val().trim(),\n        desc: root.find(SELECTORS.DESC).val().trim(),\n        studentContent: root.find(SELECTORS.STUDENT_CONTENT + ':checked').val(),\n        term: root.find(SELECTORS.STUDENT_CONTENT + ':checked').val() === 'Yes' ? '' : root.find(SELECTORS.TERM).val(),\n        assessment: 'No'\n    };\n};\n"],"file":"upload_form_media.min.js"}