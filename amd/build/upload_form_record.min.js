define ("local_kaltura/upload_form_record",["exports","jquery","core/notification","core/pubsub","core/str","core/templates","core/modal_factory","local_kaltura/modal_kaltura_progress","local_kaltura/kaltura_ajax","local_kaltura/kaltura_uploader","local_kaltura/kaltura_timer","local_kaltura/kaltura_events"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=m(b);c=m(c);f=m(f);g=m(g);h=m(h);i=m(i);j=m(j);k=m(k);l=m(l);function m(a){return a&&a.__esModule?a:{default:a}}function n(a,b){return q(a)||p(a,b)||o()}function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function p(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function q(a){if(Array.isArray(a))return a}function r(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function s(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){r(h,d,e,f,g,"next",a)}function g(a){r(h,d,e,f,g,"throw",a)}f(void 0)})}}var t,u,v,w,x={video:{deviceId:void 0},audio:{deviceId:void 0}},y={HIDDEN:"hidden",ACTIVE:"active",NO_STREAM:"kaltura-no-stream",RECORDING:"kaltura-recording",RECORDING_DONE:"kaltura-recording-complete"},z={NotAllowedError:{title:{key:"not_allowed_hdr",component:"local_kaltura"},message:{key:"not_allowed",component:"local_kaltura"}},NotFoundError:{title:{key:"not_found_hdr",component:"local_kaltura"},message:{key:"not_found",component:"local_kaltura"}},NotReadableError:{title:{key:"not_readable_hdr",component:"local_kaltura"},message:{key:"not_readable",component:"local_kaltura"}}},A={NAME:"#entry_name",TAGS:"#entry_tags",DESC:"#entry_desc",TERM:"#entry_term",STUDENT_CONTENT:"[name=\"student\"]",RECORDER:"[data-region=\"kaltura-recorder\"]",PREVIEW:"#entry_preview",PREVIEW_BUTTON:"[data-action=\"start-preview\"]",RECORD_BUTTON:"[data-action=\"start-recording\"]",STOP_BUTTON:"[data-action=\"stop-recording\"]",TIME:"[data-region=\"kaltura-recorder-time\"]",AUDIO_OPTIONS:"[data-region=\"audio-options\"]",VIDEO_OPTIONS:"[data-region=\"video-options\"]",SWITCH_DEVICE:"[data-action=\"switch-device\"]:not(.active)",DEVICE_OPTION:"[data-action=\"switch-device\"]",UPLOAD_PART_2:"[data-region=\"upload-part-2\"]",KALTURA_RECORDER_ERROR:".kaltura-recorder-alert"},B={RECORDER_ALERT:"local_kaltura/kaltura_recorder_alert",DEVICE_OPTIONS:"local_kaltura/kaltura_device_options"},C=function(a){t=(0,b.default)(a);D();E()};a.init=C;var D=function(){navigator.mediaDevices.addEventListener("devicechange",function(){P()});t.on("click",A.SWITCH_DEVICE,function(){var a=s(regeneratorRuntime.mark(function a(c){var d,e,f;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=(0,b.default)(c.currentTarget);e=d.attr("data-device-type");f=d.attr("data-device-id");d.parent().find(A.DEVICE_OPTION).removeClass(y.ACTIVE);d.addClass(y.ACTIVE);if("audioinput"===e){x.audio.deviceId=f}else if("videoinput"===e){x.video.deviceId=f}F();a.next=9;return E();case 9:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}());t.on("click",A.RECORD_BUTTON,function(){if(!u)return;G(u)});t.on("click",A.PREVIEW_BUTTON,function(){E()});t.on("click",A.STOP_BUTTON,function(){H()});t.on("submit",function(a){a.preventDefault();Q()});t.on("reset",function(){K();M();t.find(A.UPLOAD_PART_2).addClass(y.HIDDEN);t.find(A.TERM).prop("disabled",!1);t.removeClass(y.RECORDING_DONE);w=null;E()});(0,d.subscribe)(l.default.uploadModalClose,function(){if(u){F()}});t.on("change",A.STUDENT_CONTENT,function(a){t.find(A.TERM).prop("disabled","Yes"===(0,b.default)(a.currentTarget).val())})},E=function(){var a=s(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.prev=0;a.next=3;return navigator.mediaDevices.getUserMedia(x);case 3:u=a.sent;P();I(u);t.removeClass(y.NO_STREAM);M();a.next=14;break;case 10:a.prev=10;a.t0=a["catch"](0);t.addClass(y.NO_STREAM);N(a.t0);case 14:case"end":return a.stop();}}},a,null,[[0,10]])}));return function(){return a.apply(this,arguments)}}(),F=function(){var a=t.find(A.PREVIEW)[0],b=!0,c=!1,d=void 0;try{for(var e=u.getTracks()[Symbol.iterator](),f,g;!(b=(f=e.next()).done);b=!0){g=f.value;g.stop()}}catch(a){c=!0;d=a}finally{try{if(!b&&null!=e.return){e.return()}}finally{if(c){throw d}}}u=null;if(a){a.srcObject=null}},G=function(a){try{v=new MediaRecorder(a);v.ondataavailable=function(a){F();J(URL.createObjectURL(a.data));w=a.data;(0,b.default)(A.UPLOAD_PART_2).removeClass(y.HIDDEN)};v.onstart=function(){t.toggleClass(y.RECORDING,!0);(0,b.default)(A.UPLOAD_PART_2).toggleClass(y.HIDDEN,!0);k.default.startTimer(function(){L(k.default.getTime())})};v.onstop=function(){t.toggleClass(y.RECORDING,!1);t.toggleClass(y.RECORDING_DONE,!0);k.default.stopTimer();L("00:00")};v.onerror=function(a){c.default.exception(a.error)};v.start()}catch(a){c.default.exception(a)}},H=function(){v.stop()},I=function(a){var c=(0,b.default)(A.PREVIEW)[0];c.autoplay=!0;c.controls=!1;c.muted=!0;if(c.src){URL.revokeObjectURL(c.src);c.src=null}c.srcObject=a},J=function(a){var c=(0,b.default)(A.PREVIEW)[0];c.src=a;c.autoplay=!1;c.controls=!0;c.muted=!1},K=function(){var a=(0,b.default)(A.PREVIEW)[0];a.autoplay=!0;a.controls=!1;a.muted=!0;if(a.src){URL.revokeObjectURL(a.src);a.src=null}a.srcObject=null},L=function(a){(0,b.default)(A.TIME).text(a)},M=function(){t.find(A.KALTURA_RECORDER_ERROR).remove()},N=function(){var a=s(regeneratorRuntime.mark(function a(b){var d,f,g,h;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:if(z[b.name]){a.next=3;break}c.default.exception(b);return a.abrupt("return");case 3:a.next=5;return(0,e.get_strings)([z[b.name].title,z[b.name].message]);case 5:d=a.sent;f=n(d,2);g=f[0];h=f[1];O(g,h);case 10:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}(),O=function(a,b){return f.default.render(B.RECORDER_ALERT,{title:a,message:b}).then(function(a,b){return f.default.prependNodeContents(A.RECORDER,a,b)}).catch(c.default.exception)},P=function(){var a=s(regeneratorRuntime.mark(function a(){var b,d,e,g,h,i,j,k;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return navigator.mediaDevices.enumerateDevices();case 2:b=a.sent;d=b.filter(function(a){return"audioinput"===a.kind});e=b.filter(function(a){return"videoinput"===a.kind});if(u&&u.active){g=u.getTracks();h=g.find(function(a){return"audio"===a.kind}).getSettings().deviceId;i=g.find(function(a){return"video"===a.kind}).getSettings().deviceId;j=d.findIndex(function(a){return a.deviceId===h});k=e.findIndex(function(a){return a.deviceId===i});d[j].selected=!0;e[k].selected=!0}f.default.render(B.DEVICE_OPTIONS,{devices:d}).then(function(a,b){return f.default.replaceNodeContents(A.AUDIO_OPTIONS,a,b)}).catch(c.default.exception);f.default.render(B.DEVICE_OPTIONS,{devices:e}).then(function(a,b){return f.default.replaceNodeContents(A.VIDEO_OPTIONS,a,b)}).catch(c.default.exception);case 8:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}(),Q=function(){var a=s(regeneratorRuntime.mark(function a(){var e,f,k,m,o,p,q;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.prev=0;k=R();a.next=4;return Promise.all([i.default.getUploadCredentials(),g.default.create({type:h.default.getType()})]);case 4:m=a.sent;o=n(m,2);e=o[0];f=o[1];f.show();a.next=11;return j.default.upload(k,e,f.progressCallback);case 11:p=a.sent;q=(0,b.default)(p).find("entryId").text();(0,d.publish)(l.default.uploadComplete,q);a.next=19;break;case 16:a.prev=16;a.t0=a["catch"](0);c.default.exception(a.t0);case 19:a.prev=19;f.hide();f.destroy();return a.finish(19);case 23:case"end":return a.stop();}}},a,null,[[0,16,19,23]])}));return function(){return a.apply(this,arguments)}}(),R=function(){return{file:w,name:t.find(A.NAME).val().trim(),tags:t.find(A.TAGS).val().trim(),desc:t.find(A.DESC).val().trim(),studentContent:t.find(A.STUDENT_CONTENT+":checked").val(),term:"Yes"===t.find(A.STUDENT_CONTENT+":checked").val()?"":t.find(A.TERM).val(),assessment:"No"}}});
//# sourceMappingURL=upload_form_record.min.js.map
